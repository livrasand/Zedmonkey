let jsGrammar=[];function loadGrammarRules(){fetch("grammar.js").then(e=>e.text()).then(text=>{try{let grammarText=text.match(/const jsGrammar = (\[[\s\S]*?\]);/);grammarText&&grammarText[1]?(eval(text),document.getElementById("script-content")&&highlightSyntax()):(console.error("Grammar definition not found in grammar.js"),setupFallbackGrammar())}catch(e){console.error("Error parsing grammar:",e),setupFallbackGrammar()}}).catch(e=>{console.error("Error loading grammar:",e),setupFallbackGrammar()})}function highlightMatchingBrackets(a,i){if(a&&void 0!==i){var e={"(":")","{":"}","[":"]"},s={")":"(","}":"{","]":"["},c=a[i],l=0<i?a[i-1]:null;let n=-1,r,o;if(l&&e[l]){r=l,o=e[l];let t=1;for(let e=i;e<a.length;e++)if(a[e]===r)t++;else if(a[e]===o&&0===--t){n=e;break}}else if(c&&s[c]){o=c,r=s[c];let t=1;for(let e=i-1;0<=e;e--)if(a[e]===o)t++;else if(a[e]===r&&0===--t){n=e;break}}-1!==n&&console.log("Matching brackets found at positions:",i,"and",n)}}function setupFallbackGrammar(){jsGrammar=[{name:"comment",pattern:new RegExp("//.*|/\\*[\\s\\S]*?\\*/","y")},{name:"string",pattern:new RegExp("\"(?:\\\\.|[^\"\\\\])*\"|'(?:\\\\.|[^'\\\\])*'|`(?:\\\\.|[^`\\\\])*`","y")},{name:"number",pattern:new RegExp("\\b\\d+(\\.\\d+)?\\b","y")},{name:"keyword",pattern:new RegExp("\\b(?:function|const|let|var|if|else|for|while|return)\\b","y")},{name:"boolean",pattern:new RegExp("\\b(?:true|false)\\b","y")},{name:"operator",pattern:new RegExp("[=+\\-*/%<>!&|~^?:]+","y")},{name:"punctuation",pattern:new RegExp("[{}\\[\\]();,.]","y")},{name:"identifier",pattern:new RegExp("[a-zA-Z_$][a-zA-Z0-9_$]*","y")}],document.getElementById("script-content")&&highlightSyntax()}loadGrammarRules();let urlParams=new URLSearchParams(window.location.search),scriptId=urlParams.get("id"),scriptName=urlParams.get("name")||"New Script",domElements={};function getElement(e){return domElements[e]||(domElements[e]=document.getElementById(e)),domElements[e]}function deleteScript(){scriptId?confirm("Are you sure you want to delete this script?")&&chrome.runtime.sendMessage({action:"removeScript",scriptId:scriptId},e=>{e&&e.success?(showStatusMessage("Script deleted"),setTimeout(()=>{window.location.href="editor.html"},1e3)):showStatusMessage("Error deleting script",!0)}):showStatusMessage("Cannot delete new script",!0)}function applyHighlighting(e){if(!e)return"";var t=(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).split("\n"),n=[];for(let e=0;e<t.length;e++){var r=tokenizeLine(t[e]);n.push(renderLineTokens(r))}return n.join("\n")}function tokenizeLine(t){var n=[];let r=0;if(t.includes("// ==UserScript==")||t.includes("// ==/UserScript=="))n.push({type:"meta-section",text:t});else{if(t.match(/\/\/ @\w+/)){var e=t.match(/^(\/\/ @\w+)(\s+)(.+?)$/);if(e)return n.push({type:"meta",text:e[1]}),n.push({type:"plain",text:e[2]}),n.push({type:"string",text:e[3]}),n}for(;r<t.length;){let e=!1;for(var o of jsGrammar){o.pattern.lastIndex=r;var a=o.pattern.exec(t);if(a&&a.index===r){n.push({type:o.name,text:a[0]}),r+=a[0].length,e=!0;break}}e||(n.push({type:"plain",text:t[r]}),r++)}}return n}function renderLineTokens(e){return e.map(e=>`<span class="token ${e.type}">${e.text}</span>`).join("")}function highlightSyntax(){let t=document.getElementById("script-content"),n=document.getElementById("highlight-layer");t&&n&&requestAnimationFrame(()=>{var e=applyHighlighting(t.value);n.innerHTML=e,n.scrollTop=t.scrollTop,n.scrollLeft=t.scrollLeft,highlightMatchingBrackets(t.value,t.selectionStart)})}function applyHighlighting(e){return e?e.replace(/(\/\/.*$)/gm,'<span class="token comment">$1</span>').replace(/(\/\*[\s\S]*?\*\/)/g,'<span class="token comment">$1</span>').replace(/("(?:\\.|[^"\\])*")|('(?:\\.|[^'\\])*')|(`(?:\\.|[^`\\])*`)/g,'<span class="token string">$&</span>').replace(/\b(-?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?)\b/g,'<span class="token number">$1</span>').replace(/\b(function|const|let|var|return|if|else|for|while|do|switch|case|break|continue|new|try|catch|finally|throw|class|extends|import|export|default|from|async|await|this|super|yield|typeof|instanceof|in|of|delete|void|null|undefined|true|false)\b/g,'<span class="token keyword">$1</span>').replace(/(\b\w+\b)(?=\s*\()/g,'<span class="token function">$1</span>').replace(/(\w+)\.(\w+)/g,'<span class="token object">$1</span><span class="token punctuation">.</span><span class="token property">$2</span>').replace(/(function\s+\w+)\s*\(([^)]*)\)/g,(e,t,n)=>`${t}<span class="token punctuation">(</span>${n.replace(/(\w+)/g,'<span class="token parameter">$1</span>')}<span class="token punctuation">)</span>`).replace(/(\+|\-|\*|\/|%|=|==|===|!=|!==|>|<|>=|<=|&&|\|\||!|\?|:|&|\||\^|~|<<|>>|>>>|\+=|-=|\*=|\/=|%=)/g,'<span class="token operator">$1</span>').replace(/([{}[\]()<>.,;:])/g,'<span class="token punctuation">$1</span>').replace(/\b([A-Z_][A-Z0-9_]+)\b/g,'<span class="token constant">$1</span>'):""}function updateCursorPosition(){let e=document.getElementById("script-content"),t=document.getElementById("cursor-position"),n=e.value,r=e.selectionStart,o=1,a=1;for(let e=0;e<r;e++)"\n"===n[e]?(o++,a=1):a++;t.textContent=`Line: ${o}, Column: `+a,highlightCurrentLine(o)}function highlightCurrentLine(e){var t=document.getElementById("highlight-layer"),n=t.innerHTML.split("\n");for(let e=0;e<n.length;e++)n[e]=n[e].replace(/<div class="current-line">(.*?)<\/div>/g,"$1");0<e&&e<=n.length&&(n[e-1]=`<div class="current-line">${n[e-1]}</div>`),t.innerHTML=n.join("\n")}function loadTempContentIfNeeded(){"true"===new URLSearchParams(window.location.search).get("loadTemp")&&chrome.storage.local.get("tempScriptContent",e=>{e.tempScriptContent?(editor.setValue(e.tempScriptContent),chrome.storage.local.remove("tempScriptContent")):console.error("No temporary script content found")})}let highlightTimeout;function initializeEditor(){let t=document.getElementById("script-content"),n=document.getElementById("highlight-layer");if(n){document.getElementById("save-script").addEventListener("click",saveScript),document.getElementById("cancel-edit").addEventListener("click",cancelEdit);let e=document.getElementById("download-script");e&&e.addEventListener("click",downloadScript),(e=document.getElementById("refresh-script"))&&e.addEventListener("click",refreshScript),(e=document.getElementById("delete-script"))&&e.addEventListener("click",deleteScript),(e=document.getElementById("log-button"))&&e.addEventListener("click",logScriptContent),t.addEventListener("input",()=>{clearTimeout(highlightTimeout),updateLineNumbers(),updateCursorPosition(),t.value.length<1e4?highlightSyntax():highlightTimeout=setTimeout(highlightSyntax,200)}),t.addEventListener("scroll",()=>{syncScroll(),n.scrollTop=t.scrollTop,n.scrollLeft=t.scrollLeft}),t.addEventListener("keydown",handleTabKey),t.addEventListener("click",updateCursorPosition),t.addEventListener("keyup",updateCursorPosition),document.getElementById("search-scripts").addEventListener("input",filterScripts),loadAllScripts(),scriptId?loadScriptContent(scriptId):(t.value=getScriptTemplate(),updateLineNumbers(),highlightSyntax()),urlParams.get("loadTemp")&&chrome.storage.local.get("tempScriptContent",function(e){e.tempScriptContent&&(t.value=e.tempScriptContent,updateLineNumbers(),highlightSyntax(),chrome.storage.local.remove("tempScriptContent"))})}else console.error("Highlight layer not found!")}function getScriptTemplate(){return`// [script]
// name:Hello World Script,
// namespace:zedmonkey,
// version:1.0.0,
// description:Hello World!,
// match:*://*/*,
// grant:,

(function() {
    'use strict';
    
})();
`}function loadAllScripts(){chrome.runtime.sendMessage({action:"getScripts"},e=>{e&&e.scripts?renderScriptsList(e.scripts):showStatusMessage("Error loading scripts",!0)})}function renderScriptsList(e){let i=document.getElementById("scripts-list");i.innerHTML="",0===e.length?i.innerHTML='<div class="empty-state">No scripts installed</div>':e.forEach(e=>{var t=document.createElement("div"),n=(t.className="script-item",e.id===scriptId&&t.classList.add("active"),getScriptType(e)),r=(t.style.borderLeftColor="css"===n?"#4caf50":"bookmarklet"===n?"#2196f3":"#ffcc00",document.createElement("div")),o=(r.className="script-info",document.createElement("div")),a=(o.style.display="flex",o.style.alignItems="center",document.createElement("span"));a.className="script-badge "+n,a.textContent=n.toUpperCase(),o.appendChild(a),(n=document.createElement("div")).className="script-name",n.style.display="inline",n.textContent=e.metadata?.name||"Unnamed Script",o.appendChild(n),r.appendChild(o),(a=document.createElement("div")).className="script-meta",a.textContent=`v${e.metadata?.version||"1.0"} â€¢ `+(e.metadata?.match?.[0]||"*"),r.appendChild(a),e.metadata?.description&&((n=document.createElement("div")).className="script-description",n.textContent=e.metadata.description,r.appendChild(n)),(o=document.createElement("label")).className="toggle-switch",(a=document.createElement("input")).type="checkbox",a.checked=!1!==e.enabled,a.dataset.scriptId=e.id,a.addEventListener("change",toggleScriptEnabled),(n=document.createElement("span")).className="slider",o.appendChild(a),o.appendChild(n),t.appendChild(r),t.appendChild(o),r.addEventListener("click",()=>{window.location.href=`editor.html?id=${e.id}&name=`+encodeURIComponent(e.metadata?.name||"Script")}),i.appendChild(t)})}function getScriptType(e){if(e.content){if(e.metadata?.type)return e.metadata.type.toLowerCase();if(!e.content.includes("@resource")&&!e.content.includes("@require")){if(e.content.trim().startsWith("javascript:"))return"bookmarklet";e.content.includes("@-moz-document")||e.content.includes("@namespace")||e.content.includes("@media")}}return"js"}function toggleScriptEnabled(t){let e=t.target.dataset.scriptId,n=t.target.checked;chrome.runtime.sendMessage({action:"toggleScriptEnabled",scriptId:e,enabled:n},e=>{e&&e.success?showStatusMessage("Script "+(n?"enabled":"disabled")):(showStatusMessage("Error updating script state",!0),t.target.checked=!n)})}function filterScripts(e){let r=e.target.value.toLowerCase();document.querySelectorAll(".script-item").forEach(e=>{var t=e.querySelector(".script-name").textContent.toLowerCase(),n=e.querySelector(".script-meta").textContent.toLowerCase();t.includes(r)||n.includes(r)?e.style.display="flex":e.style.display="none"})}function loadScriptContent(e){chrome.runtime.sendMessage({action:"getScriptContent",scriptId:e},e=>{e&&e.content?(document.getElementById("script-content").value=e.content,updateLineNumbers(),showStatusMessage("Script loaded successfully")):showStatusMessage("Error loading script",!0)})}function saveScript(){var e,t=document.getElementById("script-content").value.trim();t?(e=scriptId?"updateScriptContent":"addScript",chrome.runtime.sendMessage({action:e,scriptContent:t,scriptId:scriptId},e=>{e&&e.success?(showStatusMessage("Script saved successfully"),!scriptId&&e.scriptId&&(window.location.href=`editor.html?id=${e.scriptId}&name=`+encodeURIComponent(e.name||"Script"))):showStatusMessage("Error saving script: "+(e.error||"Unknown error"),!0)})):showStatusMessage("Please enter script content",!0)}function cancelEdit(){window.close()}function logScriptContent(){console.log(document.getElementById("script-content").value),showStatusMessage("Script content logged to console")}function updateLineNumbers(){var e=document.getElementById("script-content"),t=document.getElementById("line-numbers"),n=e.value.split("\n").length;t.innerHTML="";for(let e=1;e<=Math.max(10,n);e++){var r=document.createElement("div");r.textContent=e,t.appendChild(r)}}function syncScroll(){var e=document.getElementById("script-content");document.getElementById("line-numbers").scrollTop=e.scrollTop}function handleTabKey(e){var t,n;"Tab"===e.key&&(e.preventDefault(),t=(e=e.target).selectionStart,n=e.selectionEnd,e.value=e.value.substring(0,t)+"  "+e.value.substring(n),e.selectionStart=e.selectionEnd=t+2)}function showStatusMessage(e,t=!1){let n=document.getElementById("status-message");n.textContent=e,n.style.color=t?"#f44336":"#4caf50",setTimeout(()=>{n.textContent=""},3e3)}function downloadScript(){var e=document.getElementById("script-content").value,t=document.getElementById("script-title").textContent.replace(/[^a-z0-9]/gi,"_").toLowerCase()+".js",e=new Blob([e],{type:"text/javascript"});let n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download=t,document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r),URL.revokeObjectURL(n)},0),showStatusMessage("Script downloaded")}function refreshScript(){scriptId?(loadScriptContent(scriptId),showStatusMessage("Script refreshed")):showStatusMessage("Cannot refresh new script",!0)}function addModalStyles(){var e=document.createElement("style");e.textContent=`
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background-color: #2d2d2d;
            border-radius: 4px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #3e3e3e;
            font-size: 16px;
            font-weight: 500;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .modal-footer {
            padding: 10px 15px;
            border-top: 1px solid #3e3e3e;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px 10px;
            background-color: #3a3a3a;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #0078d7;
        }
    `,document.head.appendChild(e)}function initializeImport(){var t=document.getElementById("import-button");let n=document.getElementById("import-dropdown");if(t&&n){var r=document.getElementById("import-local"),o=document.getElementById("import-url"),a=document.getElementById("import-cloud"),i=document.getElementById("create-new-script");addModalStyles();let e=document.createElement("input");e.type="file",e.id="file-input",e.accept=".js,.user.js,.txt",e.style.display="none",document.body.appendChild(e),createUrlImportModal(),t.addEventListener("click",e=>{e.stopPropagation(),n.classList.toggle("show")}),document.addEventListener("click",()=>{n.classList.remove("show")}),n.addEventListener("click",e=>{e.stopPropagation()}),i&&i.addEventListener("click",()=>{scriptId?window.location.href="editor.html":(document.getElementById("script-content").value=getScriptTemplate(),updateLineNumbers(),highlightSyntax(),showStatusMessage("New script template loaded")),n.classList.remove("show")}),r&&r.addEventListener("click",()=>{e.click(),n.classList.remove("show")}),e.addEventListener("change",handleFileImport),o&&o.addEventListener("click",()=>{showUrlImportModal(),n.classList.remove("show")}),a&&a.addEventListener("click",()=>{handleCloudImport(),n.classList.remove("show")})}}function createUrlImportModal(){let t=document.createElement("div");t.className="modal-overlay",t.id="url-modal",t.innerHTML=`
        <div class="modal-content">
            <div class="modal-header">Import Script from URL</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="script-url">Script URL</label>
                    <input type="url" id="script-url" placeholder="https://example.com/script.js">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="cancel-url-import">Cancel</button>
                <button class="btn primary" id="confirm-url-import">Import</button>
            </div>
        </div>
    `,document.body.appendChild(t),document.getElementById("cancel-url-import").addEventListener("click",()=>{hideUrlImportModal()}),document.getElementById("confirm-url-import").addEventListener("click",()=>{var e=document.getElementById("script-url").value.trim();e&&(importScriptFromUrl(e),hideUrlImportModal())}),t.addEventListener("click",e=>{e.target===t&&hideUrlImportModal()})}function showUrlImportModal(){document.getElementById("url-modal").classList.add("show"),document.getElementById("script-url").value="",document.getElementById("script-url").focus()}function hideUrlImportModal(){document.getElementById("url-modal").classList.remove("show")}function handleFileImport(e){let t=e.target.files[0];var n;t&&((n=new FileReader).onload=function(e){loadImportedScript(e.target.result,t.name)},n.readAsText(t),e.target.value="")}function importScriptFromUrl(t){showStatusMessage("Fetching script from URL...",!1),fetch(t).then(e=>{if(e.ok)return e.text();throw new Error("HTTP error! Status: "+e.status)}).then(e=>{loadImportedScript(e,t.split("/").pop()||"script.js")}).catch(e=>{console.error("Error fetching script:",e),showStatusMessage("Error fetching script: "+e.message,!0)})}function handleCloudImport(){showStatusMessage("Cloud import feature coming soon!",!1)}function loadImportedScript(e,t){var n;document.getElementById("script-content").value=e,scriptId||(e=document.getElementById("script-title"),n=t.replace(/\.(js|user\.js|txt)$/,""),e.textContent=n),updateLineNumbers(),highlightSyntax(),showStatusMessage(`Script "${t}" imported successfully`,!1)}document.getElementById("script-title").textContent=scriptName,document.addEventListener("DOMContentLoaded",()=>{initializeEditor(),loadTempContentIfNeeded(),initializeImport()});
async function getScripts(){return new Promise(t=>{chrome.storage.local.get("scripts",e=>{t(e.scripts||[])})})}async function saveScript(a){return new Promise((r,c)=>{getScripts().then(e=>{a.id||(a.id=Date.now().toString()),a.enabled=!1!==a.enabled;var t=e.findIndex(e=>e.id===a.id);0<=t?e[t]=a:e.push(a),chrome.storage.local.set({scripts:e},()=>{chrome.runtime.lastError?c(chrome.runtime.lastError):r(a)})})})}async function removeScript(c){return new Promise((t,r)=>{getScripts().then(e=>{e=e.filter(e=>e.id!==c),chrome.storage.local.set({scripts:e},()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t()})})})}function parseZedataBlock(e){try{var t,r,c=e.match(/\/\*\s*zedata\s*(\{[\s\S]*?\})\s*\*\//i);return c&&c[1]?(t=c[1],{name:(r=JSON.parse(t)).name||"Untitled Script",version:r.version||"1.0",match:r.match||["*://*/*"],description:r.description||"",author:r.author||"",...r}):null}catch(e){return console.error("Error parsing Zedata block:",e),null}}function parseUserscriptMetadata(t){try{var c=t.match(/\/\/\s*==UserScript==\s*([\s\S]*?)\/\/\s*==\/UserScript==/i);if(!c||!c[1])return null;let e=c[1].split("\n"),r={};return e.forEach(e=>{var t;(e=e.match(/\/\/\s*@(\w+)\s+(.*)/))&&(t=e[1].toLowerCase(),e=e[2].trim(),["match","include","exclude","require","resource","grant"].includes(t)?(r[t]||(r[t]=[]),r[t].push(e)):r[t]=e)}),{name:r.name||"Untitled Script",version:r.version||"1.0",match:r.match||r.include||["*://*/*"],description:r.description||"",author:r.author||"",...r}}catch(t){return console.error("Error parsing userscript metadata:",t),null}}function isScriptMatchingUrl(e,r){return!(!e.metadata||!e.metadata.match)&&(Array.isArray(e.metadata.match)?e.metadata.match:[e.metadata.match]).some(e=>{try{var t;return e&&"string"==typeof e?(t=e.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/^(\*:\/\/)/g,"^(https?|file|ftp)://"),new RegExp(t).test(r)):(console.error("Invalid match pattern:",e),!1)}catch(e){return console.error("Error matching URL pattern:",e),!1}})}function updateScriptCountBadge(r){r&&chrome.tabs.get(r,t=>{!chrome.runtime.lastError&&t&&t.url&&([/^chrome:\/\//,/^chrome-extension:\/\//,/^moz-extension:\/\//,/^about:/,/^edge:/,/^opera:/,/^extension:/,/^file:\/\/.*\/AppData\/Local\//,/^https:\/\/chrome\.google\.com\/webstore/,/^https:\/\/addons\.mozilla\.org/,/^https:\/\/microsoftedge\.microsoft\.com\/addons/].some(e=>e.test(t.url))?chrome.action.setBadgeText({tabId:r,text:""}):chrome.storage.sync.get("injectionEnabled",e=>{!1!==e.injectionEnabled?getScripts().then(e=>{0<(e=e.filter(e=>isScriptMatchingUrl(e,t.url)&&!1!==e.enabled)).length?(chrome.action.setBadgeText({tabId:r,text:e.length.toString()}),chrome.action.setBadgeBackgroundColor({tabId:r,color:"#3498db"})):chrome.action.setBadgeText({tabId:r,text:""})}).catch(e=>{console.error("Error getting scripts for badge:",e),chrome.action.setBadgeText({tabId:r,text:""})}):chrome.action.setBadgeText({tabId:r,text:""})}))})}async function storeScriptAsResource(e){e.id||(e.id=Date.now().toString());var t=`scripts/${e.id}.js`,e=(await chrome.storage.local.set({[t]:e.content}),await chrome.storage.local.get(t));return console.log("Storage verification:",e[t]?"OK":"MISSING"),t}import{parseScriptMetadata}from"./lib/parser.js";async function injectScript(e,t){var[r,c]=await Promise.all([chrome.storage.local.get("injectionEnabled").then(e=>!1!==e.injectionEnabled),parseScriptMetadata(t.content)]);if(r&&t.enabled&&c)try{await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},func:e=>{var t=document.createElement("script");t.textContent=e,(document.head||document.documentElement).appendChild(t).remove()},args:[t.content],world:"MAIN"})}catch(e){console.error("InyecciÃ³n fallida:",e)}}async function injectScriptWithGM(e,t){await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:["lib/gmapi.js"],world:"MAIN"}),await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},func:e=>{var t=document.createElement("script");t.type="module",t.textContent=e,(document.head||document.documentElement).appendChild(t),t.remove()},args:[t.content],world:"MAIN"})}async function injectGMApi(e){try{await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:["lib/gmapi.js"],world:"MAIN"}),console.log("gmapi.js inyectado correctamente")}catch(e){console.error("Error al inyectar gmapi.js:",e)}}async function injectScriptWithDependencies(e,t){await injectGMApi(e),await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},func:e=>{try{var t=document.createElement("script");t.textContent=e,(document.head||document.documentElement).appendChild(t),t.remove()}catch(e){console.error("Error ejecutando el script:",e)}},args:[t],world:"MAIN"})}chrome.tabs.onActivated.addListener(e=>{updateScriptCountBadge(e.tabId)}),chrome.tabs.onUpdated.addListener((e,t,r)=>{"complete"===t.status&&updateScriptCountBadge(e)}),chrome.tabs.onUpdated.addListener(async(e,t,r)=>{if("loading"===t.status&&r.url&&!(t=[/^chrome:\/\//,/^chrome-extension:\/\//,/^moz-extension:\/\//,/^about:/,/^edge:/,/^opera:/,/^extension:/,/^file:\/\/.*\/AppData\/Local\//,/^https:\/\/chrome\.google\.com\/webstore/,/^https:\/\/addons\.mozilla\.org/,/^https:\/\/microsoftedge\.microsoft\.com\/addons/].some(e=>e.test(r.url))))if(0<(t=(await getScripts()).filter(e=>isScriptMatchingUrl(e,r.url))).length){updateScriptCountBadge(e);for(var c of t)injectScript(e,c)}else chrome.action.setBadgeText({tabId:e,text:""})}),chrome.runtime.onMessage.addListener((c,t,a)=>{try{if("getScripts"===c.action)getScripts().then(e=>a({scripts:e})).catch(e=>a({error:e.message}));else if("getMatchedScripts"===c.action)getScripts().then(e=>{let t=c.url;e=e.filter(e=>isScriptMatchingUrl(e,t)),a({scripts:e})}).catch(e=>a({error:e.message}));else if("getScriptContent"===c.action)getScripts().then(e=>{e=e.find(e=>e.id===c.scriptId),a(e?{content:e.content}:{error:"Script not found"})}).catch(e=>a({error:e.message}));else if("addScript"===c.action){var e=c.scriptContent;try{saveScript({content:e,metadata:parseZedataBlock(e)||parseUserscriptMetadata(e)||{name:"Untitled Script",version:"1.0",match:["*://*/*"]}}).then(e=>a({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>a({success:!1,error:e.message}))}catch(t){console.error("Error parsing script:",t),a({success:!1,error:"Error parsing script: "+t.message})}}else if("updateScriptContent"===c.action)getScripts().then(e=>{if(e=e.find(e=>e.id===c.scriptId)){e.content=c.scriptContent;try{var t;(t=parseZedataBlock(c.scriptContent)||parseUserscriptMetadata(c.scriptContent))&&(e.metadata=t)}catch(e){console.warn("Could not update metadata:",e)}return saveScript(e)}throw new Error("Script not found")}).then(e=>a({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>a({success:!1,error:e.message}));else if("removeScript"===c.action)removeScript(c.scriptId).then(()=>a({success:!0})).catch(e=>a({success:!1,error:e.message}));else if("toggleScriptEnabled"===c.action||"toggleScript"===c.action){let{scriptId:t,enabled:r}=c;getScripts().then(e=>{if(e=e.find(e=>e.id===t))return e.enabled=r,saveScript(e);throw new Error("Script not found")}).then(()=>{a({success:!0}),chrome.tabs.query({active:!0,currentWindow:!0},e=>{e&&e[0]&&updateScriptCountBadge(e[0].id)})}).catch(e=>a({success:!1,error:e.message}))}else if("setInjectionState"===c.action){let t=c.enabled;chrome.storage.sync.set({injectionEnabled:t},()=>{a({success:!0}),chrome.tabs.query({},e=>{e.forEach(e=>{t?updateScriptCountBadge(e.id):chrome.action.setBadgeText({tabId:e.id,text:""})})})})}else if("openScriptInEditor"===c.action)try{chrome.storage.local.set({tempScriptContent:c.scriptContent},()=>{chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html?loadTemp=true")}),a({success:!0})})}catch(t){console.error("Error opening editor:",t),a({success:!1,error:t.message})}else{if("getScriptsForCurrentPage"===c.action)return getScripts().then(e=>{e=e.filter(e=>e.enabled&&isScriptMatchingUrl(e,c.url));e.forEach(e=>{chrome.tabs.sendMessage(t.tab.id,{action:"injectScript",scriptContent:e.content})}),a({count:e.length})}).catch(e=>a({error:e.message})),!0;if("getMatchedScripts"===c.action)getScripts().then(e=>{let t=c.url;e=e.filter(e=>isScriptMatchingUrl(e,t)),a({scripts:e})}).catch(e=>a({error:e.message}));else if("getScriptContent"===c.action)getScripts().then(e=>{e=e.find(e=>e.id===c.scriptId),a(e?{content:e.content}:{error:"Script not found"})}).catch(e=>a({error:e.message}));else if("addScript"===c.action){e=c.scriptContent;try{saveScript({content:e,metadata:parseZedataBlock(e)||parseUserscriptMetadata(e)||{name:"Untitled Script",version:"1.0",match:["*://*/*"]}}).then(e=>a({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>a({success:!1,error:e.message}))}catch(t){console.error("Error parsing script:",t),a({success:!1,error:"Error parsing script: "+t.message})}}else if("updateScriptContent"===c.action)getScripts().then(e=>{if(e=e.find(e=>e.id===c.scriptId)){e.content=c.scriptContent;try{var t;(t=parseZedataBlock(c.scriptContent)||parseUserscriptMetadata(c.scriptContent))&&(e.metadata=t)}catch(e){console.warn("Could not update metadata:",e)}return saveScript(e)}throw new Error("Script not found")}).then(e=>a({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>a({success:!1,error:e.message}));else if("removeScript"===c.action)removeScript(c.scriptId).then(()=>a({success:!0})).catch(e=>a({success:!1,error:e.message}));else if("toggleScriptEnabled"===c.action||"toggleScript"===c.action){let{scriptId:t,enabled:r}=c;getScripts().then(e=>{if(e=e.find(e=>e.id===t))return e.enabled=r,saveScript(e);throw new Error("Script not found")}).then(()=>{a({success:!0}),chrome.tabs.query({active:!0,currentWindow:!0},e=>{e&&e[0]&&updateScriptCountBadge(e[0].id)})}).catch(e=>a({success:!1,error:e.message}))}else if("setInjectionState"===c.action){let t=c.enabled;chrome.storage.sync.set({injectionEnabled:t},()=>{a({success:!0}),chrome.tabs.query({},e=>{e.forEach(e=>{t?updateScriptCountBadge(e.id):chrome.action.setBadgeText({tabId:e.id,text:""})})})})}else if("openScriptInEditor"===c.action)try{chrome.storage.local.set({tempScriptContent:c.scriptContent},()=>{chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html?loadTemp=true")}),a({success:!0})})}catch(t){console.error("Error opening editor:",t),a({success:!1,error:t.message})}else a({error:"Unknown action"})}return!0}catch(t){console.error("Error handling message:",t),a({error:t.message})}return!1}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"reload-without-scripts",title:"Reload page without scripts",contexts:["action"]}),chrome.contextMenus.create({id:"extension-options",title:"Extension options",contexts:["action"]})}),chrome.contextMenus.onClicked.addListener((e,r)=>{"reload-without-scripts"===e.menuItemId?chrome.storage.sync.get("injectionEnabled",e=>{let t=!1!==e.injectionEnabled;chrome.storage.sync.set({injectionEnabled:!1},()=>{chrome.tabs.reload(r.id,{bypassCache:!0},()=>{setTimeout(()=>{chrome.storage.sync.set({injectionEnabled:t})},500)})})}):"extension-options"===e.menuItemId&&chrome.runtime.openOptionsPage()}),chrome.runtime.onMessage.addListener((e,t,r)=>{"proxyRequest"===e.action&&(new XMLHttpRequest).open(e.method,e.url,!0)}),chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason?chrome.storage.local.set({firstInstall:!0},()=>{console.log("Primera instalaciÃ³n detectada, mostrando onboarding"),chrome.tabs.create({url:chrome.runtime.getURL("onboarding/welcome.html")})}):"update"===e.reason&&(console.log("ActualizaciÃ³n detectada, mostrando pÃ¡gina de novedades"),chrome.tabs.create({url:chrome.runtime.getURL("onboarding/update.html")}))}),chrome.runtime.setUninstallURL("https://zedmonkey.vercel.app/feedback.html");
async function getScripts(){return new Promise(t=>{chrome.storage.local.get("scripts",e=>{t(e.scripts||[])})})}async function saveScript(o){return new Promise((r,c)=>{getScripts().then(e=>{o.id||(o.id=Date.now().toString()),o.enabled=!1!==o.enabled;var t=e.findIndex(e=>e.id===o.id);0<=t?e[t]=o:e.push(o),chrome.storage.local.set({scripts:e},()=>{chrome.runtime.lastError?c(chrome.runtime.lastError):r(o)})})})}async function removeScript(c){return new Promise((t,r)=>{getScripts().then(e=>{e=e.filter(e=>e.id!==c),chrome.storage.local.set({scripts:e},()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t()})})})}function parseZedataBlock(e){try{var t,r,c=e.match(/\/\*\s*zedata\s*(\{[\s\S]*?\})\s*\*\//i);return c&&c[1]?(t=c[1],{name:(r=JSON.parse(t)).name||"Untitled Script",version:r.version||"1.0",match:r.match||["*://*/*"],description:r.description||"",author:r.author||"",...r}):null}catch(e){return console.error("Error parsing Zedata block:",e),null}}function parseUserscriptMetadata(t){try{var c=t.match(/\/\/\s*==UserScript==\s*([\s\S]*?)\/\/\s*==\/UserScript==/i);if(!c||!c[1])return null;let e=c[1].split("\n"),r={};return e.forEach(e=>{var t;(e=e.match(/\/\/\s*@(\w+)\s+(.*)/))&&(t=e[1].toLowerCase(),e=e[2].trim(),["match","include","exclude","require","resource","grant"].includes(t)?(r[t]||(r[t]=[]),r[t].push(e)):r[t]=e)}),{name:r.name||"Untitled Script",version:r.version||"1.0",match:r.match||r.include||["*://*/*"],description:r.description||"",author:r.author||"",...r}}catch(t){return console.error("Error parsing userscript metadata:",t),null}}function isScriptMatchingUrl(e,r){return!(!e.metadata||!e.metadata.match)&&(Array.isArray(e.metadata.match)?e.metadata.match:[e.metadata.match]).some(e=>{try{var t;return e&&"string"==typeof e?(t=e.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/^(\*:\/\/)/g,"^(https?|file|ftp)://"),new RegExp(t).test(r)):(console.error("Invalid match pattern:",e),!1)}catch(e){return console.error("Error matching URL pattern:",e),!1}})}function updateScriptCountBadge(r){r&&chrome.tabs.get(r,t=>{!chrome.runtime.lastError&&t&&t.url&&([/^chrome:\/\//,/^chrome-extension:\/\//,/^moz-extension:\/\//,/^about:/,/^edge:/,/^opera:/,/^extension:/,/^file:\/\/.*\/AppData\/Local\//,/^https:\/\/chrome\.google\.com\/webstore/,/^https:\/\/addons\.mozilla\.org/,/^https:\/\/microsoftedge\.microsoft\.com\/addons/].some(e=>e.test(t.url))?chrome.action.setBadgeText({tabId:r,text:""}):chrome.storage.sync.get("injectionEnabled",e=>{!1!==e.injectionEnabled?getScripts().then(e=>{0<(e=e.filter(e=>isScriptMatchingUrl(e,t.url)&&!1!==e.enabled)).length?(chrome.action.setBadgeText({tabId:r,text:e.length.toString()}),chrome.action.setBadgeBackgroundColor({tabId:r,color:"#3498db"})):chrome.action.setBadgeText({tabId:r,text:""})}).catch(e=>{console.error("Error getting scripts for badge:",e),chrome.action.setBadgeText({tabId:r,text:""})}):chrome.action.setBadgeText({tabId:r,text:""})}))})}async function storeScriptAsResource(e){e.id||(e.id=Date.now().toString());var t=`scripts/${e.id}.js`,e=(await chrome.storage.local.set({[t]:e.content}),await chrome.storage.local.get(t));return console.log("Storage verification:",e[t]?"OK":"MISSING"),t}async function injectScript(t,r){var c=await new Promise(t=>{chrome.storage.local.get("injectionEnabled",e=>{t(!1!==e.injectionEnabled)})});if(c&&r.enabled){c=await storeScriptAsResource(r),r=(await chrome.storage.local.get(c))[c];try{await chrome.scripting.executeScript({target:{tabId:t,allFrames:!0},func:e=>{var t=document.createElement("script");t.textContent=`(function(){${e}})();`,t.setAttribute("type","module"),t.nonce=document.querySelector("script[nonce]")?.nonce||"",t.crossOrigin="anonymous",(document.head||document.documentElement).appendChild(t),t.remove()},args:[r],world:"MAIN"})}catch(e){console.error("Main world injection failed:",e);try{await chrome.scripting.executeScript({target:{tabId:t},func:e=>{let t=document.createElement("iframe");t.style.display="none",t.sandbox="allow-scripts",document.body.appendChild(t),t.contentWindow.eval(e),setTimeout(()=>t.remove(),1e3)},args:[r],world:"MAIN"})}catch(e){console.log("Iframe sandbox injection failed, trying content script message...");try{if(!(await chrome.tabs.sendMessage(t,{action:"injectScript",resourcePath:c}))?.success)throw new Error("Content script injection failed")}catch(e){console.log("Content script fallback failed, trying nonce + src...");try{await chrome.scripting.executeScript({target:{tabId:t,allFrames:!0},func:e=>{var t=document.querySelector("script[nonce]")?.nonce||"";let r=document.createElement("script");r.src=chrome.runtime.getURL(e),r.setAttribute("nonce",t),r.crossOrigin="anonymous",(document.head||document.documentElement).appendChild(r),r.onload=()=>r.remove()},args:[c],world:"MAIN"})}catch(e){console.log("Final fallback failed, trying direct file injection...");try{await chrome.scripting.executeScript({target:{tabId:t,allFrames:!0},files:[c],world:"MAIN"})}catch(e){console.error("All injection methods failed:",e)}}}}}}}chrome.tabs.onActivated.addListener(e=>{updateScriptCountBadge(e.tabId)}),chrome.tabs.onUpdated.addListener((e,t,r)=>{"complete"===t.status&&updateScriptCountBadge(e)}),chrome.tabs.onUpdated.addListener(async(e,t,r)=>{if("loading"===t.status&&r.url&&!(t=[/^chrome:\/\//,/^chrome-extension:\/\//,/^moz-extension:\/\//,/^about:/,/^edge:/,/^opera:/,/^extension:/,/^file:\/\/.*\/AppData\/Local\//,/^https:\/\/chrome\.google\.com\/webstore/,/^https:\/\/addons\.mozilla\.org/,/^https:\/\/microsoftedge\.microsoft\.com\/addons/].some(e=>e.test(r.url))))if(0<(t=(await getScripts()).filter(e=>isScriptMatchingUrl(e,r.url))).length){updateScriptCountBadge(e);for(var c of t)injectScript(e,c)}else chrome.action.setBadgeText({tabId:e,text:""})}),chrome.runtime.onMessage.addListener((c,t,o)=>{try{if("getScripts"===c.action)getScripts().then(e=>o({scripts:e})).catch(e=>o({error:e.message}));else if("getMatchedScripts"===c.action)getScripts().then(e=>{let t=c.url;e=e.filter(e=>isScriptMatchingUrl(e,t)),o({scripts:e})}).catch(e=>o({error:e.message}));else if("getScriptContent"===c.action)getScripts().then(e=>{e=e.find(e=>e.id===c.scriptId),o(e?{content:e.content}:{error:"Script not found"})}).catch(e=>o({error:e.message}));else if("addScript"===c.action){var e=c.scriptContent;try{saveScript({content:e,metadata:parseZedataBlock(e)||parseUserscriptMetadata(e)||{name:"Untitled Script",version:"1.0",match:["*://*/*"]}}).then(e=>o({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>o({success:!1,error:e.message}))}catch(t){console.error("Error parsing script:",t),o({success:!1,error:"Error parsing script: "+t.message})}}else if("updateScriptContent"===c.action)getScripts().then(e=>{if(e=e.find(e=>e.id===c.scriptId)){e.content=c.scriptContent;try{var t;(t=parseZedataBlock(c.scriptContent)||parseUserscriptMetadata(c.scriptContent))&&(e.metadata=t)}catch(e){console.warn("Could not update metadata:",e)}return saveScript(e)}throw new Error("Script not found")}).then(e=>o({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>o({success:!1,error:e.message}));else if("removeScript"===c.action)removeScript(c.scriptId).then(()=>o({success:!0})).catch(e=>o({success:!1,error:e.message}));else if("toggleScriptEnabled"===c.action||"toggleScript"===c.action){let{scriptId:t,enabled:r}=c;getScripts().then(e=>{if(e=e.find(e=>e.id===t))return e.enabled=r,saveScript(e);throw new Error("Script not found")}).then(()=>{o({success:!0}),chrome.tabs.query({active:!0,currentWindow:!0},e=>{e&&e[0]&&updateScriptCountBadge(e[0].id)})}).catch(e=>o({success:!1,error:e.message}))}else if("setInjectionState"===c.action){let t=c.enabled;chrome.storage.sync.set({injectionEnabled:t},()=>{o({success:!0}),chrome.tabs.query({},e=>{e.forEach(e=>{t?updateScriptCountBadge(e.id):chrome.action.setBadgeText({tabId:e.id,text:""})})})})}else if("openScriptInEditor"===c.action)try{chrome.storage.local.set({tempScriptContent:c.scriptContent},()=>{chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html?loadTemp=true")}),o({success:!0})})}catch(t){console.error("Error opening editor:",t),o({success:!1,error:t.message})}else{if("getScriptsForCurrentPage"===c.action)return getScripts().then(e=>{e=e.filter(e=>e.enabled&&isScriptMatchingUrl(e,c.url));e.forEach(e=>{chrome.tabs.sendMessage(t.tab.id,{action:"injectScript",scriptContent:e.content})}),o({count:e.length})}).catch(e=>o({error:e.message})),!0;if("getMatchedScripts"===c.action)getScripts().then(e=>{let t=c.url;e=e.filter(e=>isScriptMatchingUrl(e,t)),o({scripts:e})}).catch(e=>o({error:e.message}));else if("getScriptContent"===c.action)getScripts().then(e=>{e=e.find(e=>e.id===c.scriptId),o(e?{content:e.content}:{error:"Script not found"})}).catch(e=>o({error:e.message}));else if("addScript"===c.action){e=c.scriptContent;try{saveScript({content:e,metadata:parseZedataBlock(e)||parseUserscriptMetadata(e)||{name:"Untitled Script",version:"1.0",match:["*://*/*"]}}).then(e=>o({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>o({success:!1,error:e.message}))}catch(t){console.error("Error parsing script:",t),o({success:!1,error:"Error parsing script: "+t.message})}}else if("updateScriptContent"===c.action)getScripts().then(e=>{if(e=e.find(e=>e.id===c.scriptId)){e.content=c.scriptContent;try{var t;(t=parseZedataBlock(c.scriptContent)||parseUserscriptMetadata(c.scriptContent))&&(e.metadata=t)}catch(e){console.warn("Could not update metadata:",e)}return saveScript(e)}throw new Error("Script not found")}).then(e=>o({success:!0,scriptId:e.id,name:e.metadata.name})).catch(e=>o({success:!1,error:e.message}));else if("removeScript"===c.action)removeScript(c.scriptId).then(()=>o({success:!0})).catch(e=>o({success:!1,error:e.message}));else if("toggleScriptEnabled"===c.action||"toggleScript"===c.action){let{scriptId:t,enabled:r}=c;getScripts().then(e=>{if(e=e.find(e=>e.id===t))return e.enabled=r,saveScript(e);throw new Error("Script not found")}).then(()=>{o({success:!0}),chrome.tabs.query({active:!0,currentWindow:!0},e=>{e&&e[0]&&updateScriptCountBadge(e[0].id)})}).catch(e=>o({success:!1,error:e.message}))}else if("setInjectionState"===c.action){let t=c.enabled;chrome.storage.sync.set({injectionEnabled:t},()=>{o({success:!0}),chrome.tabs.query({},e=>{e.forEach(e=>{t?updateScriptCountBadge(e.id):chrome.action.setBadgeText({tabId:e.id,text:""})})})})}else if("openScriptInEditor"===c.action)try{chrome.storage.local.set({tempScriptContent:c.scriptContent},()=>{chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html?loadTemp=true")}),o({success:!0})})}catch(t){console.error("Error opening editor:",t),o({success:!1,error:t.message})}else o({error:"Unknown action"})}return!0}catch(t){console.error("Error handling message:",t),o({error:t.message})}return!1}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"reload-without-scripts",title:"Reload page without scripts",contexts:["action"]}),chrome.contextMenus.create({id:"extension-options",title:"Extension options",contexts:["action"]})}),chrome.contextMenus.onClicked.addListener((e,r)=>{"reload-without-scripts"===e.menuItemId?chrome.storage.sync.get("injectionEnabled",e=>{let t=!1!==e.injectionEnabled;chrome.storage.sync.set({injectionEnabled:!1},()=>{chrome.tabs.reload(r.id,{bypassCache:!0},()=>{setTimeout(()=>{chrome.storage.sync.set({injectionEnabled:t})},500)})})}):"extension-options"===e.menuItemId&&chrome.runtime.openOptionsPage()}),chrome.runtime.onMessage.addListener((e,t,r)=>{"proxyRequest"===e.action&&(new XMLHttpRequest).open(e.method,e.url,!0)});
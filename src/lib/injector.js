class ZedmonkeyInjector{constructor(){this.injectedScripts=new Map,this.scriptCounter=0}async injectScript(e,t){try{var n=`zedmonkey_${++this.scriptCounter}_`+Date.now();return await this.injectGMAPI(e,t,n),t.requires&&0<t.requires.length&&await this.injectRequiredLibraries(e,t.requires),await this.injectUserScript(e,t,n),this.injectedScripts.set(n,{tabId:e,name:t.metadata?.name||"Unnamed Script",injectedAt:(new Date).toISOString()}),console.log("[Zedmonkey] Successfully injected script: "+(t.metadata?.name||n)),n}catch(e){throw console.error("[Zedmonkey] Error injecting script:",e),e}}async injectGMAPI(e,t,n){await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},func:(e,a,t)=>{e={script:{author:e.metadata?.author||"",copyright:e.metadata?.copyright||"",description:e.metadata?.description||"",excludes:e.metadata?.exclude||[],homepage:e.metadata?.homepage||e.metadata?.homepageURL||"",icon:e.metadata?.icon||"",icon64:e.metadata?.icon64||"",includes:e.metadata?.include||[],lastModified:Date.now(),matches:e.metadata?.match||[],name:e.metadata?.name||"Unnamed Script",namespace:e.metadata?.namespace||"",position:1,resources:Object.keys(t||{}),runAt:e.metadata?.["run-at"]||"document-end",supportURL:e.metadata?.supportURL||"",system:!1,unwrap:!1,version:e.metadata?.version||"1.0"},scriptMetaStr:e.metaStr||"",scriptSource:e.content||"",scriptUpdateURL:e.metadata?.updateURL||"",scriptWillUpdate:!1,scriptHandler:"Zedmonkey",version:"1.0.0",injectInto:"page",platform:{arch:"x86-64",browserName:"Chrome",browserVersion:navigator.userAgent.match(/Chrome\/(\d+)/)?.[1]||"unknown",os:navigator.platform}};new Map;let o=new Map;var n={GM_getValue:(e,n)=>new Promise(t=>{chrome.runtime.sendMessage({action:"GM_getValue",scriptId:a,name:e,defaultValue:n},e=>{t(e?.value??n)})}),GM_setValue:(e,n)=>new Promise(t=>{chrome.runtime.sendMessage({action:"GM_setValue",scriptId:a,name:e,value:n},e=>{t(e?.success||!1)})}),GM_deleteValue:e=>new Promise(t=>{chrome.runtime.sendMessage({action:"GM_deleteValue",scriptId:a,name:e},e=>{t(e?.success||!1)})}),GM_listValues:()=>new Promise(t=>{chrome.runtime.sendMessage({action:"GM_listValues",scriptId:a},e=>{t(e?.values||[])})}),GM_getResourceText:e=>(t?.[e])?.content||null,GM_getResourceURL:e=>{e=t?.[e];return e?.content?`data:${e.mime||"text/plain"};base64,`+btoa(e.content):null},GM_addElement:(e,t)=>{let n=document.createElement(e);return t&&Object.entries(t).forEach(([e,t])=>{"textContent"===e?n.textContent=t:n.setAttribute(e,t)}),n},GM_addStyle:e=>{var t=document.createElement("style");return t.textContent=e,(document.head||document.documentElement).appendChild(t),t},GM_openInTab:(e,n={})=>new Promise(t=>{chrome.runtime.sendMessage({action:"GM_openInTab",url:e,active:!1!==n.active,insert:n.insert||!1,setParent:n.setParent||!1},e=>{t(e?.tabId||null)})}),GM_registerMenuCommand:(e,t,n={})=>{var r=`menu_${Date.now()}_`+Math.random();return chrome.runtime.sendMessage({action:"GM_registerMenuCommand",scriptId:a,menuId:r,name:e,options:n}),o.set(r,t),r},GM_unregisterMenuCommand:e=>{chrome.runtime.sendMessage({action:"GM_unregisterMenuCommand",scriptId:a,menuId:e}),o.delete(e)},GM_notification:(e,t,n,r)=>{var a;"object"==typeof e&&(e=(a=e).text,t=a.title,n=a.image,r=a.onclick),chrome.runtime.sendMessage({action:"GM_notification",text:e,title:t||"Zedmonkey",image:n}),r&&(a="notif_"+Date.now(),o.set(a,r))},GM_setClipboard:(t,e=0)=>navigator.clipboard.writeText(t).catch(()=>{var e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}),GM_xmlhttpRequest:e=>new Promise((t,n)=>{chrome.runtime.sendMessage({action:"GM_xmlhttpRequest",details:e},e=>{e?.error?n(new Error(e.error)):t(e)})}),GM_download:(e,r,a={})=>{var t;return"object"==typeof e&&(e=(t=e).url,r=t.name,a=t.headers||{}),new Promise((t,n)=>{chrome.runtime.sendMessage({action:"GM_download",url:e,name:r,headers:a},e=>{e?.error?n(new Error(e.error)):t(e)})})},GM_info:e},e={getValue:n.GM_getValue,setValue:n.GM_setValue,deleteValue:n.GM_deleteValue,listValues:n.GM_listValues,getResourceText:n.GM_getResourceText,getResourceUrl:n.GM_getResourceURL,addElement:n.GM_addElement,addStyle:n.GM_addStyle,openInTab:n.GM_openInTab,registerMenuCommand:n.GM_registerMenuCommand,unregisterMenuCommand:n.GM_unregisterMenuCommand,notification:n.GM_notification,setClipboard:n.GM_setClipboard,xmlHttpRequest:n.GM_xmlhttpRequest,download:n.GM_download,info:e};Object.assign(window,n),window.GM=e,window.unsafeWindow=window,console.log("[Zedmonkey] GM API injected successfully")},args:[t,n,t.resources||{}],world:"MAIN"})}async injectRequiredLibraries(e,t){for(var n of t)try{await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},func:(e,t)=>{var n;e&&((n=document.createElement("script")).textContent=e,n.setAttribute("data-zedmonkey-require",t),(document.head||document.documentElement).appendChild(n),console.log("[Zedmonkey] Loaded required library: "+t))},args:[n.content||"",n.url||n],world:"MAIN"})}catch(e){console.warn("[Zedmonkey] Failed to load required library: "+(n.url||n),e)}}async injectUserScript(e,t,n){await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},func:(e,t,n)=>{try{var r=document.createElement("script");r.textContent=e,r.setAttribute("data-zedmonkey-script",t),r.setAttribute("data-zedmonkey-id",n),(document.head||document.documentElement).appendChild(r),console.log("[Zedmonkey] User script executed: "+t)}catch(e){console.error("[Zedmonkey] Error executing user script: "+t,e)}},args:[t.content,t.metadata?.name||"Unnamed Script",n],world:"MAIN"})}getInjectedScripts(){return Array.from(this.injectedScripts.entries()).map(([e,t])=>({id:e,...t}))}removeScript(e){return this.injectedScripts.delete(e)}clearAll(){this.injectedScripts.clear(),this.scriptCounter=0}}let injector=new ZedmonkeyInjector;function injectScript(e,t){return injector.injectScript(e,t)}function injectScriptWithResources(e,t){return injector.injectScript(e,t)}export{ZedmonkeyInjector,injector,injectScript,injectScriptWithResources};
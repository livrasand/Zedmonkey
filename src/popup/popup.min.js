function openOptions(){chrome.runtime.openOptionsPage()}function initializeUI(){document.getElementById("folder-button").addEventListener("click",toggleAllScriptsView),document.getElementById("cloud-button").addEventListener("click",toggleUpdatesView),document.getElementById("refresh-button").addEventListener("click",refreshPopup),document.getElementById("injection-toggle").addEventListener("change",toggleInjection),document.getElementById("open-extension-page").addEventListener("click",openExtensionPage),document.getElementById("add-script").addEventListener("click",showAddScriptForm),document.getElementById("import-script").addEventListener("click",importScript),chrome.storage.sync.get("injectionEnabled",e=>{e=!1!==e.injectionEnabled,document.getElementById("injection-toggle").checked=e}),checkRestrictedSite(),checkForNoScripts(),checkForUpdates()}function toggleAllScriptsView(){var e=document.getElementById("all-scripts-view"),t=document.getElementById("matched-scripts-view"),n=document.getElementById("updates-view");(e.classList.contains("hidden")?(e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden"),loadAllScripts):(e.classList.add("hidden"),t.classList.remove("hidden"),n.classList.add("hidden"),loadMatchedScripts))()}function toggleUpdatesView(){var e=document.getElementById("updates-view"),t=document.getElementById("matched-scripts-view"),n=document.getElementById("all-scripts-view");(e.classList.contains("hidden")?(e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden"),loadUpdates):(e.classList.add("hidden"),t.classList.remove("hidden"),n.classList.add("hidden"),loadMatchedScripts))()}function checkRestrictedSite(){chrome.tabs.query({active:!0,currentWindow:!0},e=>{if(e&&e[0]){let t=e[0].url;var e=[/^chrome:\/\//,/^chrome-extension:\/\//,/^moz-extension:\/\//,/^about:/,/^edge:/,/^opera:/,/^extension:/,/^file:\/\/.*\/AppData\/Local\//,/^https:\/\/chrome\.google\.com\/webstore/,/^https:\/\/addons\.mozilla\.org/,/^https:\/\/microsoftedge\.microsoft\.com\/addons/].some(e=>e.test(t)),n=document.getElementById("restricted-site-alert");e?(n.classList.remove("hidden"),document.getElementById("matched-scripts-list").innerHTML='<div class="empty-state">Scripts cannot run on this page</div>'):n.classList.add("hidden")}else console.error("No active tab found")})}function refreshPopup(){var e=document.getElementById("updates-view"),t=document.getElementById("all-scripts-view");(e.classList.contains("hidden")?t.classList.contains("hidden")?(loadMatchedScripts(),checkForNoScripts):loadAllScripts:loadUpdates)(),chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]&&document.getElementById("userscript-alert")&&checkForUserscripts(e[0].url)}),checkRestrictedSite(),checkForUpdates()}function showAddScriptForm(){chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html")})}function toggleInjection(e){e=e.target.checked;chrome.storage.local.set({injectionEnabled:e},()=>{chrome.runtime.sendMessage({action:"refreshAllTabs"})})}function openExtensionPage(e){e.preventDefault(),chrome.runtime.openOptionsPage()}function openEditorPage(e){e.preventDefault(),chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html")})}function checkForUserscripts(e){let c=document.getElementById("userscript-alert");c?chrome.tabs.query({active:!0,currentWindow:!0},e=>{e&&e[0]?chrome.tabs.sendMessage(e[0].id,{action:"detectUserscript"},e=>{var t,n;chrome.runtime.lastError?console.log("Content script not ready:",chrome.runtime.lastError.message):e&&e.detected&&(c.classList.remove("hidden"),t=extractScriptName(e.scriptContent),(n=document.getElementById("detected-script-name"))&&(n.textContent=t||"Unknown Script"),c.dataset.scriptContent=e.scriptContent)}):console.error("No active tab found")}):console.log("Userscript alert element not found in DOM")}function extractScriptName(e){var t;return e?(t=e.match(/@name\s+(.+?)(\n|$)/))&&t[1]||(t=e.match(/\[script\][\s\S]*?name\s*=\s*["'](.+?)["']/))&&t[1]?t[1].trim():"Unknown Script":null}function checkForNoScripts(){document.getElementById("matched-scripts-view").classList.contains("hidden")||chrome.tabs.query({active:!0,currentWindow:!0},e=>{if(e&&e[0]){if(!isRestrictedSite(e=e[0].url)){let n="";try{n=new URL(e).hostname}catch(e){return void console.error("Invalid URL:",e)}chrome.runtime.sendMessage({action:"getMatchedScripts",url:e},e=>{var e=e?.scripts||[],t=document.getElementById("no-scripts-alert");0===e.length?(t.classList.remove("hidden"),document.getElementById("search-openuserjs").href="https://openuserjs.org/?q="+n,document.getElementById("search-greasyfork").href="https://greasyfork.org/scripts/search?q="+n,document.getElementById("search-github").href=`https://github.com/search?q=${n}+userscript&type=code`,document.getElementById("search-userscripts-zone").href="https://www.userscript.zone/search?q="+n,document.querySelectorAll(".search-options a").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),chrome.tabs.create({url:e.target.href})})})):t.classList.add("hidden")})}}else console.error("No active tab found")})}function isRestrictedSite(t){return[/^chrome:\/\//,/^chrome-extension:\/\//,/^moz-extension:\/\//,/^about:/,/^edge:/,/^opera:/,/^extension:/,/^file:\/\/.*\/AppData\/Local\//,/^https:\/\/chrome\.google\.com\/webstore/,/^https:\/\/addons\.mozilla\.org/,/^https:\/\/microsoftedge\.microsoft\.com\/addons/].some(e=>e.test(t))}function showAddScriptForm(){chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html")})}function importScript(){var e=document.createElement("input");e.type="file",e.accept=".js,.user.js",e.onchange=e=>{var t;(e=e.target.files[0])&&((t=new FileReader).onload=e=>{chrome.storage.local.set({tempScriptContent:e.target.result},function(){chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html?loadTemp=true")})})},t.readAsText(e))},e.click()}function installDetectedScript(){var e=document.getElementById("userscript-alert"),t=e.dataset.scriptContent;t?(console.log("Storing script content for editor:",t.substring(0,100)+"..."),chrome.storage.local.set({tempScriptContent:t},function(){chrome.runtime.lastError?console.error("Error storing script content:",chrome.runtime.lastError):chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html?loadTemp=true")})}),e.classList.add("hidden")):console.error("No script content found in userscript-alert element")}function loadAllScripts(){let t=document.getElementById("all-scripts-list");chrome.runtime.sendMessage({action:"getScripts"},e=>{chrome.runtime.lastError?(console.error("Error loading scripts:",chrome.runtime.lastError),t.innerHTML='<div class="empty-state">Error loading scripts</div>'):0===(e=e&&e.scripts?e.scripts:[]).length?t.innerHTML='<div class="empty-state">No scripts installed</div>':(t.innerHTML="",e.forEach(e=>{t.appendChild(createScriptElement(e,!0))}))})}function loadMatchedScripts(){let n=document.getElementById("matched-scripts-list");chrome.tabs.query({active:!0,currentWindow:!0},e=>{e=e[0],chrome.runtime.sendMessage({action:"getMatchedScripts",url:e.url},e=>{0===(e=e.scripts||[]).length?n.innerHTML='<div class="empty-state">No scripts match this page</div>':(n.innerHTML="",e.forEach(e=>{var t=!0===e.matchedInSubframe;n.appendChild(createScriptElement(e,!1,t))}))})})}function checkForUpdates(){chrome.runtime.sendMessage({action:"checkUpdates"},e=>{var t;chrome.runtime.lastError?console.error("Error checking updates:",chrome.runtime.lastError):(e=e&&e.updates?e.updates:[],t=document.getElementById("update-badge"),0<e.length?(t.textContent=e.length,t.classList.remove("hidden")):t.classList.add("hidden"))})}function loadUpdates(){let o=document.getElementById("updates-list");chrome.runtime.sendMessage({action:"getUpdates"},e=>{0===(e=e.updates||[]).length?o.innerHTML='<div class="empty-state">No updates available</div>':(o.innerHTML="",e.forEach(e=>{var t=document.createElement("div"),n=(t.className="script-item",document.createElement("div")),c=(n.className="script-info",document.createElement("div")),r=(c.className="script-name",c.textContent=e.metadata.name,document.createElement("div")),s=(r.className="script-version",r.textContent=`v${e.currentVersion} → v`+e.newVersion,document.createElement("div")),i=(s.className="script-actions",document.createElement("button"));i.className="btn-icon update",i.innerHTML="↑",i.title="Update script",i.addEventListener("click",()=>updateScript(e.id)),n.appendChild(c),n.appendChild(r),s.appendChild(i),t.appendChild(n),t.appendChild(s),o.appendChild(t)}))})}function createScriptElement(t,n=!0,e=!1){let c=document.createElement("div");c.className="script-item";var r,s,i,o=document.createElement("div"),a=(o.className="script-info",document.createElement("div")),d=(a.className="script-name-container",document.createElement("span")),l=(d.className="script-name",d.textContent=t.metadata.name,document.createElement("span"));l.className="script-type "+getScriptType(t),l.textContent=getScriptType(t).toUpperCase(),e&&((e=document.createElement("span")).className="script-subframe",e.textContent="sub",a.appendChild(e));(e=document.createElement("div")).className="script-version",e.textContent="v"+t.metadata.version;var m=document.createElement("div");return m.className="script-actions",n&&((r=document.createElement("label")).className="script-toggle",(s=document.createElement("input")).type="checkbox",s.checked=!1!==t.enabled,s.addEventListener("change",e=>{toggleScript(t.id,e.target.checked),e.stopPropagation()}),(i=document.createElement("span")).className="script-toggle-slider",r.appendChild(s),r.appendChild(i),m.appendChild(r)),a.appendChild(d),a.appendChild(l),o.appendChild(a),o.appendChild(e),c.appendChild(o),c.appendChild(m),c.addEventListener("click",()=>{var e;n&&((e=c.querySelector('input[type="checkbox"]')).checked=!e.checked,toggleScript(t.id,e.checked))}),c}function getScriptType(e){return"css"===e.metadata.type||e.content&&e.content.trim().startsWith("/* ==UserStyle== */")||e.metadata.name.toLowerCase().includes(".css")?"css":"js"}function toggleScript(e,t){chrome.runtime.sendMessage({action:"toggleScript",scriptId:e,enabled:t},e=>{e.success&&!1===document.getElementById("matched-scripts-view").classList.contains("hidden")&&loadMatchedScripts()})}function updateScript(e){chrome.runtime.sendMessage({action:"updateScript",scriptId:e},e=>{e.success?(loadUpdates(),checkForUpdates()):alert("Error updating script: "+e.error)})}document.addEventListener("DOMContentLoaded",async()=>{initializeUI();var[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),t=(loadMatchedScripts(),document.getElementById("userscript-alert"));t&&e&&checkForUserscripts(e.url)}),document.getElementById("open-dashboard").addEventListener("click",function(){chrome.tabs.create({url:chrome.runtime.getURL("editor/editor.html")})});